name: CD - Build & Push Docker image

on:
  push:
    branches:
      - main
      - prod
      - clementDS

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write   # pour pousser sur GHCR

    env:
      REGISTRY: ghcr.io
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # ðŸ‘‡ NORMALISATION DU NOM REPO (lowercase obligatoire)
      - name: Normalize repo name to lowercase
        id: vars_repo
        run: |
          echo "IMAGE_NAME=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      # ðŸ‘‡ CALCUL DU TAG (main â†’ latest, prod â†’ prod, sinon â†’ nom de branche lowercase)
      - name: Set image tag
        id: vars
        run: |
          if [ "${{ github.ref_name }}" = "main" ]; then
            echo "TAG=latest" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref_name }}" = "prod" ]; then
            echo "TAG=prod" >> $GITHUB_OUTPUT
          else
            echo "TAG=$(echo '${{ github.ref_name }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
          fi

      # ðŸ‘‡ BUILD AVEC NOM CORRIGÃ‰
      - name: Build Docker image
        run: |
          docker build \
            -f docker/Dockerfile \
            -t $REGISTRY/${{ steps.vars_repo.outputs.IMAGE_NAME }}:${{ steps.vars.outputs.TAG }} \
            .

      # ðŸ‘‡ PUSH
      - name: Push Docker image
        run: |
          docker push $REGISTRY/${{ steps.vars_repo.outputs.IMAGE_NAME }}:${{ steps.vars.outputs.TAG }}