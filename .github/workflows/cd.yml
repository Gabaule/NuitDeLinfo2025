name: CD - Build & Push Docker image

on:
  push:
    branches:
      - main
      - prod
      - clementDS   # <= remplace par le nom de TA branche de test CD si besoin

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write   # nécessaire pour pousser sur GHCR

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # 1) LOGIN à GitHub Container Registry
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      # 2) Mettre le nom du repo (owner/repo) en lowercase pour GHCR
      - name: Normalize repo name to lowercase
        id: vars_repo
        run: |
          echo "IMAGE_NAME=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      # 3) Choisir le tag de l'image en fonction de la branche
      - name: Set image tag
        id: vars
        run: |
          if [ "${{ github.ref_name }}" = "main" ]; then
            echo "TAG=latest" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref_name }}" = "prod" ]; then
            echo "TAG=prod" >> $GITHUB_OUTPUT
          else
            echo "TAG=$(echo '${{ github.ref_name }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
          fi

      # 4) Build de l'image Docker
      - name: Build Docker image
        run: |
          docker build \
            -f docker/Dockerfile \
            -t ghcr.io/${{ steps.vars_repo.outputs.IMAGE_NAME }}:${{ steps.vars.outputs.TAG }} \
            .

      # 5) Push de l'image vers GHCR
      - name: Push Docker image
        run: |
          docker push ghcr.io/${{ steps.vars_repo.outputs.IMAGE_NAME }}:${{ steps.vars.outputs.TAG }}
