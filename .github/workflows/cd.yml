name: CD - Build & Push Docker image

on:
  push:
    branches:
      - prod
      - clementDS   # branche de test CD

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write   # nécessaire pour pousser sur GHCR

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # 1) LOGIN à GitHub Container Registry
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      # 2) Mettre le nom du repo (owner/repo) en lowercase pour GHCR
      - name: Normalize repo name to lowercase
        id: vars_repo
        run: |
          echo "IMAGE_NAME=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      # 3) Définir les tags (base + tag daté)
      - name: Set image tags
        id: tags
        run: |
          # Tag principal selon la branche
          if [ "${{ github.ref_name }}" = "main" ]; then
            BASE_TAG="latest"
          elif [ "${{ github.ref_name }}" = "prod" ]; then
            BASE_TAG="prod"
          else
            BASE_TAG=$(echo '${{ github.ref_name }}' | tr '[:upper:]' '[:lower:]')
          fi

          # Tag avec date UTC + nom de branche (toujours lowercase)
          DATE_PART=$(date -u +"%Y%m%d-%H%M%S")
          BRANCH_LOWER=$(echo '${{ github.ref_name }}' | tr '[:upper:]' '[:lower:]')
          DATE_TAG="${DATE_PART}-${BRANCH_LOWER}"

          echo "BASE_TAG=$BASE_TAG" >> $GITHUB_OUTPUT
          echo "DATE_TAG=$DATE_TAG" >> $GITHUB_OUTPUT

          echo "Base tag: $BASE_TAG"
          echo "Date tag: $DATE_TAG"

      # 4) Build de l'image Docker avec les deux tags
      - name: Build Docker image
        run: |
          IMAGE="ghcr.io/${{ steps.vars_repo.outputs.IMAGE_NAME }}"
          docker build \
            -f docker/Dockerfile \
            -t $IMAGE:${{ steps.tags.outputs.BASE_TAG }} \
            -t $IMAGE:${{ steps.tags.outputs.DATE_TAG }} \
            .

      # 5) Push de l'image vers GHCR (les deux tags)
      - name: Push Docker image
        run: |
          IMAGE="ghcr.io/${{ steps.vars_repo.outputs.IMAGE_NAME }}"
          docker push $IMAGE:${{ steps.tags.outputs.BASE_TAG }}
          docker push $IMAGE:${{ steps.tags.outputs.DATE_TAG }}
